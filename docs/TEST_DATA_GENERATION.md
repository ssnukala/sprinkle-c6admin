# Dynamic Test Data Generation for C6Admin

## Overview

C6Admin uses a **schema-driven SQL generation approach** for test data instead of PHP seed classes. This provides flexibility, maintainability, and automatic adaptation to schema changes.

## Files

### Generator Script
- **Location**: `app/tests/generate-test-data.php`
- **Purpose**: Reads JSON schemas and configuration to generate SQL INSERT statements
- **Features**:
  - Schema-driven field type handling
  - Automatic ON DUPLICATE KEY UPDATE for idempotency
  - Support for foreign key lookups (e.g., group_id by slug)
  - Relationship/pivot table support
  - Type-safe SQL value generation

### Configuration File
- **Location**: `app/tests/test-data-config.json`
- **Purpose**: Defines what test data to create
- **Structure**:
  ```json
  {
    "models": [
      {
        "model": "groups",
        "description": "Test groups",
        "records": [
          { "slug": "developers", "name": "Developers", ... }
        ]
      }
    ],
    "relationships": [
      {
        "pivot_table": "role_users",
        "assignments": [ ... ]
      }
    ]
  }
  ```

### Generated SQL File
- **Location**: `app/tests/test-data.sql`
- **Purpose**: Final SQL with INSERT statements
- **Generated by**: `php generate-test-data.php > test-data.sql`
- **Features**:
  - Idempotent (can run multiple times)
  - Includes comments for documentation
  - Uses SELECT for foreign key lookups
  - ON DUPLICATE KEY UPDATE for all inserts

## Usage

### Generating SQL

```bash
cd app/tests
php generate-test-data.php > test-data.sql
```

### Executing SQL

```bash
# In UserFrosting project after migrations and base seeds
mysql -h host -u user -p database < vendor/ssnukala/sprinkle-c6admin/app/tests/test-data.sql
```

### In CI/CD (GitHub Actions)

The workflow automatically:
1. Runs UserFrosting migrations
2. Runs UserFrosting base seeds (Account, CRUD6)
3. Creates admin user
4. **Executes C6Admin test data SQL**
5. Validates seeded data
6. Tests SQL idempotency

## Modifying Test Data

### Adding New Groups

Edit `test-data-config.json`:

```json
{
  "model": "groups",
  "records": [
    {
      "_comment": "My new group",
      "slug": "mygroup",
      "name": "My Group",
      "description": "Group description",
      "icon": "fa fa-icon"
    }
  ]
}
```

### Adding New Users

```json
{
  "model": "users",
  "records": [
    {
      "_comment": "New test user",
      "user_name": "newuser",
      "first_name": "New",
      "last_name": "User",
      "email": "newuser@example.com",
      "password": "$2y$10$...",
      "flag_enabled": 1,
      "flag_verified": 1,
      "_group_slug": "developers",
      "_roles": ["user"]
    }
  ]
}
```

### Adding Role Assignments

```json
{
  "relationships": [
    {
      "description": "Role assignments for newuser",
      "pivot_table": "role_users",
      "foreign_key": "user_id",
      "related_key": "role_id",
      "assignments": [
        {
          "select": "SELECT `users`.`id`, `roles`.`id`\nFROM `users`, `roles`\nWHERE `users`.`user_name` = 'newuser' AND `roles`.`slug` = 'user'"
        }
      ]
    }
  ]
}
```

## How It Works

### 1. Schema Reading

The generator reads JSON schemas from `app/schema/crud6/*.json`:
- Gets field types (string, integer, boolean, etc.)
- Identifies readonly/auto_increment fields
- Determines table and primary key names

### 2. Field Processing

For each record in the configuration:
- Skips metadata fields (start with `_`)
- Converts values to SQL format based on field type
- Handles special cases (e.g., `_group_slug` for lookups)

### 3. SQL Generation

**For regular fields**:
```sql
INSERT INTO `users` (`user_name`, `email`, `group_id`)
VALUES ('testuser', 'test@example.com', 1)
ON DUPLICATE KEY UPDATE ...
```

**For foreign key lookups**:
```sql
INSERT INTO `users` (`user_name`, `email`, `group_id`)
SELECT 'testuser', 'test@example.com', `groups`.`id`
FROM `groups`
WHERE `groups`.`slug` = 'developers'
ON DUPLICATE KEY UPDATE ...
```

### 4. Idempotency

All INSERTs include `ON DUPLICATE KEY UPDATE` clauses:
- Can be run multiple times safely
- Updates existing records instead of failing
- Tested automatically in CI

## Benefits

✅ **Schema-Driven**: Automatically adapts to schema changes
✅ **Flexible**: Easy to modify via JSON configuration
✅ **Type-Safe**: Correct SQL generation based on field types
✅ **Reusable**: Works with any model with a JSON schema
✅ **Maintainable**: Single source of truth (schemas)
✅ **Testable**: Built-in idempotency testing
✅ **Documented**: Generated SQL includes comments
✅ **CI-Ready**: Integrates seamlessly with GitHub Actions

## Comparison: PHP Seeds vs SQL Generation

| Feature | PHP Seeds | SQL Generation |
|---------|-----------|----------------|
| Flexibility | Manual code changes | JSON configuration |
| Schema Sync | Manual updates | Automatic from schema |
| Idempotency | Manual implementation | Built-in (ON DUPLICATE KEY) |
| Type Safety | Runtime errors | Compile-time validation |
| Maintenance | High (code + namespaces) | Low (config only) |
| CI Integration | Complex (class loading) | Simple (SQL execution) |
| Debugging | Stack traces | SQL output |
| Reusability | Limited to PHP | Any SQL-compatible tool |

## Migration from PHP Seeds

The old PHP seed files have been removed:
- ❌ `app/tests/Database/Seeds/TestGroups.php` (deleted)
- ❌ `app/tests/Database/Seeds/TestUsers.php` (deleted)
- ❌ `app/src/C6Admin.php` - Removed `SeedRecipe` implementation

All functionality is now provided by the SQL generation system.

## Troubleshooting

### "Table not found" error
**Cause**: Migrations haven't run yet
**Solution**: Run migrations before executing SQL

### "Foreign key constraint fails"  
**Cause**: Referenced records don't exist (e.g., roles, groups)
**Solution**: Ensure UserFrosting base seeds have run first

### "Duplicate entry" error (without ON DUPLICATE KEY)
**Cause**: SQL file regenerated without idempotency
**Solution**: Regenerate with current generator script

### Schema changes not reflected
**Cause**: SQL file not regenerated
**Solution**: Run `php generate-test-data.php > test-data.sql`

## Future Enhancements

Potential improvements:
- [ ] Support for multiple environments (dev, test, staging)
- [ ] Configurable password hashing
- [ ] Automatic schema validation
- [ ] Interactive CLI for adding records
- [ ] Support for custom SQL functions
- [ ] Template-based SQL generation
